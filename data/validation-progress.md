# 패치 데이터 검증 작업 진행 문서

## 작업 개요

Firebase에 저장된 캐릭터 패치 데이터가 원본 패치노트와 일치하는지 검증하고,
불일치하는 데이터를 기록하여 수정할 수 있도록 함.

---

## 검증 결과 요약 (2025-12-31)

### 총계

- **총 이슈: 313개**
- 변경사항 개수 불일치: 280개
- 코멘트 불일치: 33개
- 코멘트 누락: 0개

### 영향받은 실험체: 74명

---

## 문제 원인 분석

### 크롤링 로직 (`parse-balance-changes.ts`) 분석 결과

1. **설명형 변경사항 누락** (가장 큰 문제):
   - 화살표(→)가 없는 설명형 변경사항이 제대로 수집되지 않음
   - 예: "Q1 스킬 사용 후 바로 쿨다운이 적용되도록 변경됩니다."
   - 예: "기본 공격 적중 시 스태미나 회복 (삭제)"
   - 예: "뒤로 회피 후 캐스팅이 끝나는 순간 이동 불가 효과에 의해 이동이 취소 될 수 있습니다. (신규)"

2. **중첩된 li 구조 문제**:
   - 스킬 헤더 다음에 오는 세부 변경사항이 누락됨
   - 같은 스킬에 여러 변경사항이 있을 때 일부만 수집

3. **개발자 코멘트 수집 문제** (33개):
   - 여러 p 태그에 걸친 코멘트가 완전히 수집되지 않음
   - 저장된 코멘트가 원문보다 짧음

---

## 실험체별 이슈 수 (Top 20)

| 순위 | 실험체      | 이슈 수 | 상태   |
| ---- | ----------- | ------- | ------ |
| 1    | 이렘        | 19개    | 미수정 |
| 2    | 아르다      | 18개    | 미수정 |
| 3    | 이안        | 16개    | 미수정 |
| 4    | 데비&마를렌 | 13개    | 미수정 |
| 5    | 알렉스      | 13개    | 미수정 |
| 6    | 나딘        | 10개    | 미수정 |
| 7    | 마르티나    | 9개     | 미수정 |
| 8    | 헤이즈      | 9개     | 미수정 |
| 9    | 에이든      | 7개     | 미수정 |
| 10   | 츠바메      | 7개     | 미수정 |
| 11   | 수아        | 7개     | 미수정 |
| 12   | 실비아      | 7개     | 미수정 |
| 13   | 재키        | 7개     | 미수정 |
| 14   | 루크        | 7개     | 미수정 |
| 15   | 블레어      | 6개     | 미수정 |
| 16   | 바바라      | 6개     | 미수정 |
| 17   | 엠마        | 6개     | 미수정 |
| 18   | 띠아        | 6개     | 미수정 |
| 19   | 히스이      | 6개     | 미수정 |
| 20   | 마이        | 6개     | 미수정 |

---

## 히스이 상세 이슈

테스트 케이스로 확인된 히스이의 불일치:

### patchId 2513 (v1.40) - 6개 누락

- 무기 스킬이 적중하더라도 거합 중첩을 획득하지 않도록 변경됩니다.
- 적에게 적중한 경우에만 이동하도록 변경됩니다.
- 히스이의 추가 공격 속도에 비례한 스킬 시전 시간 감소 효과가 강화됩니다.
- 에어본 지속 시간 0.25초 → 0.4초
- 뒤로 회피 후 캐스팅이 끝나는 순간 이동 불가 효과에 의해 이동이 취소 될 수 있습니다. (신규)
- 코멘트 길이 불일치 (475자 vs 196자)

### patchId 2426 (v1.38) - 1개 누락

- 처형 기준이 츠바메가에시로 피해 입힌 후 대상 최대 체력 10% 미만일 때로 변경됩니다.

### patchId 2415 (v1.37c) - 1개 누락

- 이제 랭크 대전에서 사용할 수 있습니다. (코멘트로 잘못 저장됨)

---

## 수정 방안

### 옵션 1: 크롤링 로직 수정 후 재파싱 (권장)

장점:

- 모든 문제를 한 번에 해결
- 향후 새 패치도 정확하게 파싱

단점:

- 시간이 걸림
- 기존 데이터 덮어쓰기 필요

수정 필요 사항:

1. 설명형 변경사항 수집 로직 개선
2. 중첩 li 구조 처리 개선
3. 코멘트 수집 로직 개선

### 옵션 2: 수동 수정 (긴급 시)

- 관리자 페이지(`/admin/character/[name]`)를 통해 직접 수정
- 이슈가 적은 실험체부터 수정

### 옵션 3: 직접 데이터 수정 스크립트

- JSON 파일로 수정 데이터 정의
- Firestore에 직접 업데이트

---

## 작업 완료 상태

- [x] 작업 진행 문서 생성
- [x] 크롤링 로직 분석
- [x] 히스이 테스트 케이스 확인
- [x] 전체 실험체 검증 실행
- [x] 불일치 목록 기록 (data/validation-issues.json)
- [x] 크롤링 로직 수정 (2025-12-31)
- [x] 문제가 있는 패치 재파싱 실행 (2025-12-31)
- [x] 수정본 JSON 생성 (data/patch-fixes.json)
- [ ] 사용자 검토 후 Firebase 적용

---

## 참고 파일

- `scripts/validate-patch-data.ts` - 검증 스크립트
- `scripts/parse-balance-changes.ts` - 크롤링/파싱 스크립트
- `scripts/reparse-patches.ts` - 재파싱 스크립트
- `scripts/apply-fixes.ts` - 수정본 Firebase 적용 스크립트
- `data/validation-issues.json` - 검증 결과 (313개 이슈)
- `data/patches-to-reparse.json` - 재파싱 대상 패치 목록 (80개)
- `data/patch-fixes.json` - 수정본 데이터 (264개 항목)

---

## 작업 로그

### 2025-12-31 (검증)

- 검증 스크립트 실행 완료
- 총 124개 패치, 85명 캐릭터 검증
- 313개 이슈 발견 (280개 변경사항 누락, 33개 코멘트 불일치)
- 74명 실험체에서 문제 발견
- 주요 원인: 설명형 변경사항(화살표 없음) 누락

### 2025-12-31 (크롤링 로직 수정)

- `parse-balance-changes.ts` 수정 완료
- **수정 내용**:
  1. 설명형 변경사항 수집 로직 개선 (화살표 없는 텍스트도 수집)
  2. topLi 헤더 텍스트도 변경사항으로 처리
  3. 스킬 헤더 패턴 정규식 개선 (서브스킬 형태 지원)
  4. 코멘트 수집 조건 개선 (길이 10자 이상, 스킬 헤더 제외)
  5. `isRemoved` 플래그 추가 (삭제된 효과 구분)
  6. 테스트 모드 추가 (`--test --patch=ID --character=이름`)
- **테스트 결과**:
  - 히스이 2513: 2개 → 7개 변경사항, 코멘트 196자 → 475자
  - 히스이 2426: 2개 → 3개 변경사항 (처형 기준 추가)
  - 히스이 2415: 2개 → 3개 변경사항 (랭크 대전 알림 추가)
- Lint 검사 통과

### 2025-12-31 (재파싱 및 수정본 생성)

- `scripts/reparse-patches.ts` 작성 - 문제 패치 재파싱 스크립트
- `scripts/apply-fixes.ts` 작성 - Firebase 적용 스크립트
- **재파싱 결과**:
  - 처리된 패치: 80개
  - 수정 필요 항목: 264개
  - 영향받는 캐릭터: 76명
  - 추가될 변경사항: 614개
  - 코멘트 수정: 54개
- 수정본 JSON 생성 완료 (`data/patch-fixes.json`)

---

## 다음 작업

1. `data/patch-fixes.json` 검토
2. 검토 완료 후 `npx tsx scripts/apply-fixes.ts` 실행하여 Firebase 반영

### apply-fixes.ts 사용법

```bash
# 전체 반영 (확인 모드)
npx tsx scripts/apply-fixes.ts --dry-run

# 전체 반영 (실제)
npx tsx scripts/apply-fixes.ts

# 특정 캐릭터만 반영
npx tsx scripts/apply-fixes.ts --character=히스이

# 제한된 수만 반영
npx tsx scripts/apply-fixes.ts --limit=10
```

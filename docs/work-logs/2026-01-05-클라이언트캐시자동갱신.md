# 클라이언트 캐시 자동 갱신

## 개요

- **시작일**: 2026-01-05
- **상태**: 완료
- **관련 브랜치**: feature/23

## 목표

- [x] 데이터 버전 API 생성 (`/api/data-version`)
- [x] 버전 체크 훅 생성 (`useDataVersionCheck`)
- [x] 레이아웃에 버전 체크 적용
- [x] Revalidation API 생성 (`/api/revalidate`)
- [x] 크롤링 스크립트에 revalidation 호출 추가
- [x] 빌드 ID 기반 자동 새로고침 구현

## 문제 상황

1. Firebase에서 데이터가 업데이트되어도 사용자가 새로고침하지 않으면 반영 안됨
2. 빌드 후 클라이언트 캐시와 서버 데이터 불일치로 404 발생

## 해결 방안

### 1. 크롤링/관리자 수정 시 캐시 무효화

- `/api/revalidate` API로 서버 캐시 즉시 무효화
- 크롤링 스크립트에서 자동 호출

### 2. 새 빌드 배포 시 자동 새로고침

- 빌드 ID (VERCEL_GIT_COMMIT_SHA) 비교
- 빌드 ID 다르면 `window.location.reload()` (hard refresh)

### 3. 데이터 업데이트 시 soft refresh

- 데이터 버전(updatedAt) 비교
- 버전 다르면 `router.refresh()`

### 체크 시점 (매분 polling 없음)

- 페이지 이동 시
- 탭 복귀 시 (visibility change)

## 진행 상황

### 2026-01-05

- Revalidation API 생성 (`/api/revalidate`)
- 빌드 ID + 데이터 버전 체크 훅 구현
- 크롤링 스크립트에 revalidation 호출 추가
- 빌드/lint 테스트 통과

## 환경 변수 설정 필요

```bash
# Vercel 환경변수 또는 .env.local
REVALIDATE_SECRET=your-secret-key

# GitHub Actions secrets (크롤링 스크립트용)
SITE_URL=https://er-patch-tracker.vercel.app
REVALIDATE_SECRET=your-secret-key
```

## 관련 파일

- `src/app/api/data-version/route.ts` - 빌드 ID + 데이터 버전 API
- `src/app/api/revalidate/route.ts` - 외부 revalidation API
- `src/hooks/useDataVersionCheck.ts` - 버전 체크 훅
- `src/components/Providers.tsx` - 버전 체커 적용
- `scripts/lib/revalidate.ts` - 스크립트용 revalidation 유틸
- `scripts/crawl-patch-notes.ts` - 크롤링 후 revalidation 호출
- `scripts/parse-balance-changes.ts` - 파싱 후 revalidation 호출

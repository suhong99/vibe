# On-demand 캐시 무효화 구현

## 개요

- **시작일**: 2026-01-07
- **상태**: 진행중
- **관련 브랜치**: feature/25

## 문제 상황

관리자 페이지에서 가넷 데이터를 수정했는데, 배포 환경에서 새로고침해도 반영되지 않음.
Firebase Firestore에는 데이터가 정상적으로 저장됨.

## 원인 분석

### 1차 분석 (잘못된 진단)

- `generateStaticParams()`로 빌드 시점에 정적 페이지 생성 (SSG)
- 페이지에 `revalidate` 설정이 없어서 빌드 후 절대 갱신되지 않음
- → `revalidate = false` 추가했으나 의미 없었음 (삭제)

### 2차 분석 (진짜 원인)

**모듈 레벨 캐시가 API Route와 Page에서 서로 다른 인스턴스 사용**

```
┌─────────────────┐     ┌─────────────────┐
│   API Route     │     │     Page        │
│ balanceDataCache│     │ balanceDataCache│
│     = null      │     │   = {...data}   │ ← 이건 안 지워짐!
└─────────────────┘     └─────────────────┘
```

- `clearBalanceDataCache()` 호출 시 API Route의 캐시만 지워짐
- Page의 모듈 레벨 캐시는 그대로 유지됨
- 첫 번째 수정은 되지만, 두 번째부터 안 되는 현상 발생

## 목표

- [x] 모듈 레벨 캐시 제거
- [x] `unstable_cache`만 사용하도록 변경
- [x] clear 함수 호출 제거
- [ ] 테스트 및 배포

## 진행 상황

### 2026-01-07

1. 1차 시도: `revalidate = false` 추가 → 실패 (의미 없음)

2. 로그 추가하여 디버깅
   - API Route에서 `clearBalanceDataCache()` 호출 시 `before: null`
   - Page에서 `fetchBalanceData()` 호출 시 `Returning from module-level cache`
   - → API와 Page가 다른 모듈 인스턴스 사용 확인

3. 모듈 레벨 캐시 제거
   - `src/lib/patch-data.ts`에서 `balanceDataCache`, `patchNotesDataCache` 변수 제거
   - `clearBalanceDataCache()`, `clearPatchNotesDataCache()` 함수 제거
   - `fetchBalanceData()` 내 캐시 체크 로직 제거

4. clear 함수 호출 제거
   - `src/app/api/admin/characters/[name]/patches/[patchId]/route.ts`
   - `src/app/api/revalidate/route.ts`

## 해결 방법

**모듈 레벨 캐시 제거, `unstable_cache`만 사용**

```typescript
// 이전: 모듈 레벨 캐시 + unstable_cache (이중 캐싱)
let balanceDataCache = null;
const fetchBalanceData = async () => {
  if (balanceDataCache) return balanceDataCache;  // 문제!
  // ...
};
export const loadBalanceData = unstable_cache(fetchBalanceData, ...);

// 이후: unstable_cache만 사용
const fetchBalanceData = async () => {
  // 항상 Firebase에서 조회
  // ...
};
export const loadBalanceData = unstable_cache(fetchBalanceData, ...);
```

캐시 무효화는 `revalidateTag()`만으로 처리:

```typescript
revalidateTag('balance-data', 'max');
revalidateTag('patch-notes-data', 'max');
```

## 변경된 파일

- `src/lib/patch-data.ts` - 모듈 레벨 캐시 제거
- `src/app/api/admin/characters/[name]/patches/[patchId]/route.ts` - clear 함수 호출 제거
- `src/app/api/revalidate/route.ts` - clear 함수 호출 제거

## 중단 시 이어서 할 작업

- [ ] `npm run build && npm run start`로 로컬 테스트
- [ ] 테스트 통과 시 PR 생성 및 배포
